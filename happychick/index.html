<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小鸡下蛋小游戏</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; }
        #gameCanvas { display: block; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="loading">资源加载中...</div>

<script>
class ChickenGame {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.resizeCanvas();
        this.gameScale = 2; // 高清缩放比例
        this.assets = {
            chick: ['idle1.png', 'idle2.png'],
            egg: 'egg.png',
            scoreBoard: 'score.png'
        };
        this.loaded = false;
        this.init();
    }

    async init() {
        window.addEventListener('resize', () => this.resizeCanvas());
        await this.loadResources();
        this.setupGame();
        this.startGame();
    }

    resizeCanvas() {
        this.canvas.width = window.innerWidth * window.devicePixelRatio;
        this.canvas.height = window.innerHeight * window.devicePixelRatio;
        this.canvas.style.width = window.innerWidth + 'px';
        this.canvas.style.height = window.innerHeight + 'px';
    }

    async loadResources() {
        try {
            // 预加载所有资源
            this.images = {
                chick: await this.loadImageSeries(this.assets.chick),
                egg: await this.loadImage(this.assets.egg),
                scoreBoard: await this.loadImage(this.assets.scoreBoard)
            };
            
            document.getElementById('loading').remove();
            this.loaded = true;
        } catch (error) {
            console.error('资源加载失败:', error);
            document.getElementById('loading').textContent = '资源加载失败，请刷新重试';
        }
    }

    loadImage(path) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = 'images/' + path;
            img.onload = () => resolve(img);
            img.onerror = () => reject(`图片加载失败: ${path}`);
        });
    }

    loadImageSeries(paths) {
        return Promise.all(paths.map(p => this.loadImage(p)));
    }

    setupGame() {
        // 游戏状态初始化
        this.chick = {
            x: this.canvas.width/2,
            y: this.canvas.height/2,
            frame: 0,
            state: 'idle',
            animationTimer: 0
        };
        
        this.eggs = [];
        this.score = 0;
        
        // 事件监听
        this.canvas.addEventListener('click', (e) => this.handleClick(e));
        this.canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.handleClick(e.touches[0]);
        });
    }

    handleClick(event) {
        if (!this.loaded || this.chick.state !== 'idle') return;

        const rect = this.canvas.getBoundingClientRect();
        const clickX = (event.clientX - rect.left) * this.gameScale;
        const clickY = (event.clientY - rect.top) * this.gameScale;

        if (this.checkCollision(clickX, clickY)) {
            this.moveChicken();
            this.chick.state = 'egg';
            setTimeout(() => {
                this.layEgg();
                this.chick.state = 'idle';
            }, 300); // 下蛋动作持续时间
        }
    }

    checkCollision(x, y) {
        const chicken = this.images.chick[0];
        return x > this.chick.x && x < this.chick.x + chicken.width &&
               y > this.chick.y && y < this.chick.y + chicken.height;
    }

    moveChicken() {
        const chicken = this.images.chick[0];
        this.chick.x = Math.random() * (this.canvas.width - chicken.width);
        this.chick.y = Math.random() * (this.canvas.height - chicken.height);
    }

    layEgg() {
        const chicken = this.images.chick[0];
        this.eggs.push({
            x: this.chick.x + chicken.width/2 - this.images.egg.width/2,
            y: this.chick.y + chicken.height,
            timer: Date.now()
        });
        this.score++;
    }

    updateAnimation() {
        if (this.chick.state === 'idle') {
            this.chick.animationTimer++;
            if (this.chick.animationTimer % 10 === 0) {
                this.chick.frame = (this.chick.frame + 1) % this.images.chick.length;
            }
        }
    }

    draw() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // 绘制鸡蛋
        this.eggs.forEach(egg => {
            this.ctx.drawImage(this.images.egg, egg.x, egg.y);
        });

        // 绘制小鸡
        const currentFrame = this.images.chick[this.chick.frame];
        this.ctx.drawImage(currentFrame, this.chick.x, this.chick.y);

        // 绘制分数板
        const scoreBoard = this.images.scoreBoard;
        const boardX = this.canvas.width - scoreBoard.width - 20;
        const boardY = 20;
        this.ctx.drawImage(scoreBoard, boardX, boardY);
        this.ctx.fillStyle = 'white';
        this.ctx.font = 'bold 24px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.fillText(this.score, boardX + scoreBoard.width/2, boardY + scoreBoard.height/2 + 8);
    }

    gameLoop() {
        if (!this.loaded) return;
        
        this.updateAnimation();
        this.draw();
        setTimeout(() => this.gameLoop(), 1000/30); // 30fps
    }

    startGame() {
        this.gameLoop();
    }
}

// 启动游戏
new ChickenGame();
</script>
</body>
</html>
